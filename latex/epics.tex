%% Generated by Sphinx.
\def\sphinxdocclass{jsbook}
\documentclass[letterpaper,10pt,dvipdfmx]{sphinxmanual}
\ifdefined\pdfpxdimen
   \let\sphinxpxdimen\pdfpxdimen\else\newdimen\sphinxpxdimen
\fi \sphinxpxdimen=.75bp\relax

\PassOptionsToPackage{warn}{textcomp}


\usepackage{cmap}
\usepackage[T1]{fontenc}
\usepackage{amsmath,amssymb,amstext}



\usepackage{times}


\usepackage{sphinx}

\fvset{fontsize=\small}
\usepackage[dvipdfm]{geometry}


% Include hyperref last.
\usepackage{hyperref}
% Fix anchor placement for figures with captions.
\usepackage{hypcap}% it must be loaded after hyperref.
% Set up styles of URL: it should be placed after hyperref.
\urlstyle{same}
\usepackage{pxjahyper}

\renewcommand{\contentsname}{Contents:}

\usepackage{sphinxmessages}
\setcounter{tocdepth}{1}



\title{EPICSの備忘録}
\date{2022年08月26日}
\release{}
\author{西田 賢人}
\newcommand{\sphinxlogo}{\vbox{}}
\renewcommand{\releasename}{}
\makeindex
\begin{document}

\pagestyle{empty}
\sphinxmaketitle
\pagestyle{plain}
\sphinxtableofcontents
\pagestyle{normal}
\phantomsection\label{\detokenize{index::doc}}



\chapter{EPICSとは}
\label{\detokenize{epics/rst/epics_index:epics}}\label{\detokenize{epics/rst/epics_index::doc}}

\section{EPICSの概要}
\label{\detokenize{epics/rst/epics_index:id1}}\begin{itemize}
\item {} 
EPICSは、PCから複数の制御機器を統括的に取り扱えるようにした制御用ミドルウェア、サーバ、命令群である．

\item {} 
ユーザPCのソフトウェアとハードウェアをシームレスに接続できる環境を提供しうる．

\item {} 
開発元は、アルゴンヌ国立研究所．Open License (EPICS Open License)である．

\item {} 
公式の説明は以下の通り.

\end{itemize}

\begin{sphinxadmonition}{note}{Note:}
"EPICS is a set of Open Source software tools, libraries and applications developed collaboratively and used worldwide to create distributed soft real\sphinxhyphen{}time control systems for scientific instruments such as a particle accelerators, telescopes and other large scientific experiments."
\end{sphinxadmonition}


\section{EPICSの特徴}
\label{\detokenize{epics/rst/epics_index:id2}}
以下のようなシステムの制御を得意とする．
\begin{itemize}
\item {} 
多数の機器がぶらさがった大規模システムを統括的に制御できる．

\item {} 
高速・リアルタイムな通信が可能

\item {} 
柔軟かつスケーラブルで、拡張が容易である．

\end{itemize}


\chapter{EPICS 適用}
\label{\detokenize{epics/rst/epics_index:id3}}

\section{EPICSサーバの導入について}
\label{\detokenize{epics/rst/basic_startup:epics}}\label{\detokenize{epics/rst/basic_startup::doc}}
ここでは、EPICSサーバの初期設定、及び、基本動作テストについて記載する．


\subsection{環境}
\label{\detokenize{epics/rst/basic_startup:id1}}
以下の環境を想定する．
\begin{itemize}
\item {} 
IOCとして使用するPC： \sphinxstylestrong{Raspberry Pi 2 Model B}

\item {} 
OS : Raspbian

\item {} 
user名：epics

\item {} 
EPICS導入ディレクトリ （環境変数\$\{EPICS\_BASE\}）： /home/epics/epics/epics\sphinxhyphen{}base/

\end{itemize}


\subsection{EPICS( epics\sphinxhyphen{}base ) のインストール}
\label{\detokenize{epics/rst/basic_startup:epics-epics-base}}

\subsubsection{epcis\sphinxhyphen{}baseのダウンロード及びインストール}
\label{\detokenize{epics/rst/basic_startup:epcis-base}}\begin{itemize}
\item {} 
baseの本家ウェブサイト( \sphinxurl{https://docs.epics-controls.org/projects/how-tos/en/latest/getting-started/installation.html} )に従う.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} git clone \PYGZhy{}\PYGZhy{}recursive https://github.com/epics\PYGZhy{}base/epics\PYGZhy{}base.git
\PYGZdl{} cd epics\PYGZhy{}base
\PYGZdl{} make
\end{sphinxVerbatim}

\end{itemize}


\subsubsection{環境変数の設定}
\label{\detokenize{epics/rst/basic_startup:id2}}\begin{itemize}
\item {} 
以下を \$\{HOME\}/.zshrc や \$\{HOME\}/.bash\_profile 等へ書き込む

\begin{sphinxVerbatim}[commandchars=\\\{\}]
export EPICS\PYGZus{}BASE=\PYGZdl{}\PYGZob{}HOME\PYGZcb{}/epics/epics\PYGZhy{}base
export EPICS\PYGZus{}HOST\PYGZus{}ARCH=\PYGZdl{}(\PYGZdl{}\PYGZob{}EPICS\PYGZus{}BASE\PYGZcb{}/startup/EpicsHostArch)
export PATH=\PYGZdl{}\PYGZob{}EPICS\PYGZus{}BASE\PYGZcb{}/bin/\PYGZdl{}\PYGZob{}EPICS\PYGZus{}HOST\PYGZus{}ARCH\PYGZcb{}:\PYGZdl{}\PYGZob{}PATH\PYGZcb{}
\end{sphinxVerbatim}

\end{itemize}


\subsubsection{epics\sphinxhyphen{}baseのテスト}
\label{\detokenize{epics/rst/basic_startup:epics-base}}\begin{itemize}
\item {} 
以下の、データベースファイル( \sphinxstylestrong{.dbファイル} ,example.db )を作成する．

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{record}\PYG{p}{(}\PYG{n}{ai}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{temperature:water}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{p}{\PYGZob{}}
  \PYG{n}{field}\PYG{p}{(}\PYG{n}{DESC}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Water temperature in the fish tank}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{p}{\PYGZcb{}}
\end{sphinxVerbatim}

\item {} 
以下、コマンドにて実行する．

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} softIoc \PYGZhy{}d example.db
epics\PYGZgt{}
( EPICSコンソールに入る．新規コンソールを立ち上げて、以下を実行. )
\PYGZdl{} caput temperature:water 22
\PYGZdl{} caget temperature:water
\end{sphinxVerbatim}

\end{itemize}


\subsection{その他、モジュールのインストール}
\label{\detokenize{epics/rst/basic_startup:id3}}\begin{itemize}
\item {} 
EPICSサーバを使用する際に、ハードウェア機器に応じて、拡張モジュールを使用する事が多い．

\item {} 
導入するモジュールは例えば、以下．
\begin{itemize}
\item {} 
ASYN (Asynchronous (非同期通信用モジュール)re2cが必要)

\item {} 
Stream Devices (バイトストリーム処理用モジュール：例えば1バイト文字列を利用した制御RS\sphinxhyphen{}232C等)

\item {} 
seq (シーケンサー, C言語ライクな状態記述言語によるプログラム)

\item {} 
devGpio ( Raspberry Pi のGPIO端子の制御用モジュール、主はエラーで動作できていない．)

\end{itemize}

\item {} 
インストールは各websiteに従えば、問題なくインストール可能．

\end{itemize}


\section{EPICSの用語集}
\label{\detokenize{epics/rst/vocabulary:epics}}\label{\detokenize{epics/rst/vocabulary::doc}}

\subsection{概念・機器構成編}
\label{\detokenize{epics/rst/vocabulary:id1}}
EPICS制御の機器構成・概念を理解する上で必要となる用語について、以下に備忘録を記す．


\begin{savenotes}\sphinxattablestart
\centering
\sphinxcapstartof{table}
\sphinxthecaptionisattop
\sphinxcaption{\sphinxstylestrong{用語集（EPICS 概念・機器構成）}}\label{\detokenize{epics/rst/vocabulary:id4}}
\sphinxaftertopcaption
\begin{tabular}[t]{|\X{10}{55}|\X{15}{55}|\X{30}{55}|}
\hline
\sphinxstyletheadfamily 
用語
&\sphinxstyletheadfamily 
略, 別名
&\sphinxstyletheadfamily 
説明
\\
\hline
EPICS
&
Experimental Physics and Industrial Control System
&
制御用ミドルウェア、ツールパッケージの総称
\\
\hline
IOC
&
Input/Output Controler
&
ハード側の制御器．ハード機器に制御命令を出す．下位層にあたる．
\\
\hline
OPI
&
OPerational Interface
&
ユーザ側の制御ソフトウェア．上位層．
\\
\hline
\end{tabular}
\par
\sphinxattableend\end{savenotes}


\subsection{モジュール・ソフトウェア編}
\label{\detokenize{epics/rst/vocabulary:id2}}
EPICS制御に用いるモジュール・ソフトウェアの用語について、以下に備忘録を記す．


\begin{savenotes}\sphinxattablestart
\centering
\sphinxcapstartof{table}
\sphinxthecaptionisattop
\sphinxcaption{\sphinxstylestrong{用語集（モジュール・ソフトウェア）}}\label{\detokenize{epics/rst/vocabulary:id5}}
\sphinxaftertopcaption
\begin{tabular}[t]{|\X{10}{55}|\X{15}{55}|\X{30}{55}|}
\hline
\sphinxstyletheadfamily 
用語
&\sphinxstyletheadfamily 
略, 別名
&\sphinxstyletheadfamily 
説明
\\
\hline
Asyn
&&
非同期通信制御用のモジュール．StreamDevices内でも使用される．ユーザに近い位置で積極的に使用するのは、時代遅れの可能性あり．StreamDeviceを使用すべきか．
\\
\hline
StreamDevice
&
stream etc.
&
バイトストリームを取り扱う制御モジュール．１バイト文字等を送信するため制御（つまりはRS\sphinxhyphen{}232CやUSB含むSerial制御、等、なんでも制御可能．protocolファイルとdbファイルの設定のみで制御できるため重宝されている様子）
\\
\hline
re2c
&&
字句解析ツール．数式等を理解し、コードを自動ジェネレートするなどに使用する．Asynで使用．apt管理されている．
\\
\hline
\end{tabular}
\par
\sphinxattableend\end{savenotes}


\subsection{ファイル編}
\label{\detokenize{epics/rst/vocabulary:id3}}
EPICSで使用するファイルについて、以下に備忘録を記す．


\begin{savenotes}\sphinxattablestart
\centering
\sphinxcapstartof{table}
\sphinxthecaptionisattop
\sphinxcaption{\sphinxstylestrong{用語集（EPICS 概念・機器構成）}}\label{\detokenize{epics/rst/vocabulary:id6}}
\sphinxaftertopcaption
\begin{tabular}[t]{|\X{10}{55}|\X{15}{55}|\X{30}{55}|}
\hline
\sphinxstyletheadfamily 
ファイル名/拡張子
&\sphinxstyletheadfamily 
意味
&\sphinxstyletheadfamily 
説明
\\
\hline
.db
&
database
&
EPICSで入出力管理するレコード（データ型、タイミングなど）を記述する
\\
\hline
.proto
&
protocol
&
StreamDeviceで使用するプロトコル（データ入出力・受け渡し形式について記載するファイル）
\\
\hline
configure/RELEASE
&&
EPICS\_BASEやモジュールのインストール位置等、コンパイルに必要な情報を記載するファイル．
\\
\hline
\end{tabular}
\par
\sphinxattableend\end{savenotes}


\section{基本動作例１： Googleにtelnet接続するEPICS制御}
\label{\detokenize{epics/rst/example1__httpRequest_to_Google:googletelnetepics}}\label{\detokenize{epics/rst/example1__httpRequest_to_Google::doc}}

\subsection{検証目標}
\label{\detokenize{epics/rst/example1__httpRequest_to_Google:id1}}\begin{itemize}
\item {} 
IOCを構築．

\item {} 
IOCの動作検証．

\item {} 
IOCとOPI間で通信する．

( IOC:Input/Output Controller, OPI:OPerational Interface )

\end{itemize}


\subsection{前提条件}
\label{\detokenize{epics/rst/example1__httpRequest_to_Google:id2}}\begin{itemize}
\item {} 
IOCとして \sphinxstylestrong{"RaspberryPi"} 、OPIとして、手元PCのmacOSを使用する．

\item {} 
RaspberryPi\sphinxhyphen{}mac間はLANケーブルで接続し、RaspberryPiはインターネットへ接続できる．(同一LAN内.)

\item {} 
接続先は、適当なサーバ：www.google.com:80 (80はHTML通信用のウェルノウンポート) とし、HTTPリクエストする．

\item {} 
制御モジュールとして、 \sphinxstylestrong{"StremDevice"} を使用する．

\item {} 
IOC(RaspberryPi)に、epics\sphinxhyphen{}base, Asyn, StreamDevice はインストール済み

\item {} 
OPI(macOS)からは,  pythonコンソールから \sphinxstylestrong{"pyEpics"} (pipからインストール可能)を利用する．

\item {} 
EPICS\_BASEは、"\$HOME/epics/epics\sphinxhyphen{}base", サポートモジュールは、"\$HOME/epics/support/"にインストールされており、 Appの作成場所は, "\$HOME/epics/app/"とする．

\end{itemize}


\subsection{IOC構築}
\label{\detokenize{epics/rst/example1__httpRequest_to_Google:ioc}}

\subsubsection{IOC構築の手順}
\label{\detokenize{epics/rst/example1__httpRequest_to_Google:id3}}\begin{itemize}
\item {} 
IOC\sphinxhyphen{}App(アプリ)構築の基本手順は、以下である．
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxstylestrong{ベースアプリ} を作成する．

\item {} 
\sphinxstylestrong{configure/RELEASE} にコンパイルに必要な情報(EPICS\_BASEのパス/モジュールのパス)を記載する．

\item {} 
\sphinxstylestrong{"xxxApp"} ディレクトリに、データベース及び使用するモジュールの情報を記載する．

\item {} 
StreamDeviceなどモジュールを利用する際は、モジュールに応じた設定ファイル（例えばStreamDeviceの場合、 \sphinxstylestrong{protocols} ディレクトリに \sphinxstylestrong{xxx.proto} ） を作成する．

\item {} 
\sphinxstylestrong{iocBoot} ディレクトリの \sphinxstylestrong{ioc\_xxx**内にあるIOC初期化スクリプト **"st.cmd"} を編集し、実行可能とする．

\item {} 
アプリのベースディレクトリ（\$(TOP)としてMakefile中に記載されている）にて、 \$ make 、したのちに、sudo 権限付きで IOC初期化スクリプト "st.cmd" を実行する

\end{enumerate}

\end{itemize}

以下、上記手順について詳述する．


\subsubsection{1. ベースアプリの作成}
\label{\detokenize{epics/rst/example1__httpRequest_to_Google:id4}}\begin{itemize}
\item {} 
makeBaseApp.plを用いたベースアプリの作成

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} mkdir \PYGZhy{}p \PYGZti{}/epics/app/http\PYGZus{}req
\PYGZdl{} cd  \PYGZti{}/epics/app/http\PYGZus{}req
\PYGZdl{} makeBaseApp.pl \PYGZhy{}t ioc http\PYGZus{}req
\PYGZdl{} makeBaseApp.pl \PYGZhy{}i \PYGZhy{}t ioc http\PYGZus{}req
\end{sphinxVerbatim}

\item {} 
1回目のmakeBaseApp.plで作成されるファイル・ディレクトリは以下．
\begin{itemize}
\item {} 
Makefile

\item {} 
configure

\item {} 
http\_reqApp

\end{itemize}

\item {} 
2回目のmakeBaseApp.plで作成されるファイル・ディレクトリは以下．
\begin{itemize}
\item {} 
iocBoot

\end{itemize}

\item {} 
ディレクトリツリーは以下．

\noindent{\hspace*{\fill}\sphinxincludegraphics[width=600\sphinxpxdimen]{{DirectoryTree_makeBaseApp}.png}\hspace*{\fill}}

\end{itemize}


\subsubsection{2. 共通コンパイル設定事項の編集 ( configure/RELEASE )}
\label{\detokenize{epics/rst/example1__httpRequest_to_Google:configure-release}}\begin{itemize}
\item {} 
configure/RELEASEに、共通のコンパイル設定（モジュールの場所等、）を例えば以下のように記載する．

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{ASYN}   \PYG{o}{=} \PYG{o}{/}\PYG{n}{home}\PYG{o}{/}\PYG{n}{epics}\PYG{o}{/}\PYG{n}{epics}\PYG{o}{/}\PYG{n}{support}\PYG{o}{/}\PYG{n}{asyn}
\PYG{n}{STREAM} \PYG{o}{=} \PYG{o}{/}\PYG{n}{home}\PYG{o}{/}\PYG{n}{epics}\PYG{o}{/}\PYG{n}{epics}\PYG{o}{/}\PYG{n}{support}\PYG{o}{/}\PYG{n}{StreamDevice}
\end{sphinxVerbatim}

\end{itemize}


\subsubsection{3. データベースファイルとコンパイルの準備}
\label{\detokenize{epics/rst/example1__httpRequest_to_Google:id5}}\begin{itemize}
\item {} 
データベース及び使用するモジュールの情報を記載し、\textasciitilde{}/epics/app/http\_req/http\_reqApp/Db/http\_req.dbを作成する．

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} nano \PYGZti{}/epics/app/http\PYGZus{}req/http\PYGZus{}reqApp/Db/http\PYGZus{}req.db
( 以下を保存 )
record( stringin, \PYGZdq{}http:get\PYGZdq{} )
\PYGZob{}
field( DESC, \PYGZdq{}getbitstream\PYGZdq{} )
field( DTYP, \PYGZdq{}stream\PYGZdq{} )
field( INP , \PYGZdq{}@http\PYGZus{}req.proto getVal web\PYGZdq{})
\PYGZcb{}
\end{sphinxVerbatim}

\item {} 
データベースのコンパイル対象として、上記の"http\_req.db"を追加．

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} nano \PYGZti{}/epics/app/http\PYGZus{}req/http\PYGZus{}reqApp/Db/Makefile
( 以下を追記 )
DB += http\PYGZus{}req.db
\end{sphinxVerbatim}

\item {} 
その他モジュールを利用する場合は、IOCの通信コードのコンパイルに使用するモジュール情報を、 "http\_reqApp/src/Makefile" に記載し、コンパイルできるようにする．

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} nano \PYGZti{}/epics/app/http\PYGZus{}req/http\PYGZus{}reqApp/src/Makefile
( 以下を追記 )
http\PYGZus{}req\PYGZus{}DBD  += stream.dbd
http\PYGZus{}req\PYGZus{}DBD  += asyn.dbd
http\PYGZus{}req\PYGZus{}DBD  += drvAsynIPPort.dbd

http\PYGZus{}req\PYGZus{}LIBS += stream
http\PYGZus{}req\PYGZus{}LIBS += asyn
\end{sphinxVerbatim}

\end{itemize}


\subsubsection{4. StreamDeviceの設定ファイル ( "protocol" )の作成}
\label{\detokenize{epics/rst/example1__httpRequest_to_Google:streamdevice-protocol}}\begin{itemize}
\item {} 
アプリのベースディレクトリ ( \textasciitilde{}/epics/app/http\_req/ )にディレクトリ "protocols"を作成し、StreamDeviceの入出力情報を記載する．

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} mkdir \PYGZdl{}HOME/epics/app/http\PYGZus{}req/protocols
\PYGZdl{} nano http\PYGZus{}req.proto

(以下を記入)
Terminator = CR LF;
getVal \PYGZob{}
out \PYGZdq{}GET / HTTP/1.1\PYGZbs{}nHost: www.google.co.jp\PYGZbs{}n\PYGZdq{};
in \PYGZdq{}\PYGZpc{}39c\PYGZdq{};
ExtraInput = Ignore;
\PYGZcb{}
\end{sphinxVerbatim}

\end{itemize}


\subsubsection{5. IOC 初期化スクリプト "st.cmd" の編集}
\label{\detokenize{epics/rst/example1__httpRequest_to_Google:ioc-st-cmd}}\begin{itemize}
\item {} 
IOC初期化スクリプト ( iocBoot/iochttp\_req/st.cmd ) に、以下の情報を記載する．
\begin{itemize}
\item {} 
StreamDeviceを使用する場合、protocolsディレクトリの位置を記載する．

\item {} 
初期化時にロードするデータベースファイルを記載する．

\item {} 
ethernetケーブルなどの、ハードウェアを使用する場合は、設定を記載する．

\end{itemize}

\item {} 
ここでは、以下を記載する．

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{epicsEnvSet}\PYG{p}{(} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{STREAM\PYGZus{}PROTOCOL\PYGZus{}PATH}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{.:../../protocols}\PYG{l+s+s2}{\PYGZdq{}} \PYG{p}{)}
\PYG{n}{dbLoadRecords}\PYG{p}{(} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{db/http\PYGZus{}req.db}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{user=epics}\PYG{l+s+s2}{\PYGZdq{}} \PYG{p}{)}
\PYG{n}{drvAsynIPPortConfigure} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{web}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{www.google.co.jp:80}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{l+m+mi}{0}
\end{sphinxVerbatim}

\item {} 
スクリプトに実行権限を与えておく．

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} chmod u+x \PYGZdl{}HOME/epics/app/http\PYGZus{}req/iocBoot/iochttp\PYGZus{}req/st.cmd
\end{sphinxVerbatim}

\end{itemize}


\subsubsection{6. make 及び、初期化スクリプト "st.cmd" の実行}
\label{\detokenize{epics/rst/example1__httpRequest_to_Google:make-st-cmd}}\begin{itemize}
\item {} 
ベースディレクトリにて make する．

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} cd \PYGZdl{}HOME/epics/app/http\PYGZus{}req/
\PYGZdl{} make distclean
\PYGZdl{} make
\end{sphinxVerbatim}

\item {} 
初期化スクリプトを実行する．

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} cd \PYGZdl{}HOME/epics/app/http\PYGZus{}req/iocBoot/iochttp\PYGZus{}req/
\PYGZdl{} sudo ./st.cmd
\end{sphinxVerbatim}

\end{itemize}


\subsection{IOCの動作状況の確認}
\label{\detokenize{epics/rst/example1__httpRequest_to_Google:id6}}

\subsubsection{EPICSコンソール上での確認}
\label{\detokenize{epics/rst/example1__httpRequest_to_Google:epics}}\begin{itemize}
\item {} 
EPICSコンソールへエラーなく遷移していることを確認．

\item {} 
以下を実行．

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{epics}\PYG{o}{\PYGZgt{}} \PYG{n}{dbpf} \PYG{n}{http}\PYG{p}{:}\PYG{n}{get} \PYG{l+m+mi}{0}
\PYG{n}{epics}\PYG{o}{\PYGZgt{}} \PYG{n}{dbgf} \PYG{n}{http}\PYG{p}{:}\PYG{n}{get}
\end{sphinxVerbatim}

\item {} 
戻り値は、

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{DBF\PYGZus{}STRING}\PYG{p}{:}         \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{HTTP/1.1 200 OK}\PYG{l+s+s2}{\PYGZdq{}}
\end{sphinxVerbatim}

\end{itemize}


\subsubsection{ローカルからのCA}
\label{\detokenize{epics/rst/example1__httpRequest_to_Google:ca}}\begin{itemize}
\item {} 
epics\sphinxhyphen{}baseがインストールされているIOC/OPIでは、PV(Process Variable)にCA(Channel Access)が可能

\item {} 
別コンソールを立ち上げて、以下コマンドを実行

\begin{sphinxVerbatim}[commandchars=\\\{\}]
epics@raspberrypi: \PYGZti{} \PYGZdl{} caget http:get
http:get  HTTP/1.1 200 OK
\end{sphinxVerbatim}

\end{itemize}


\subsubsection{OPI（手元macOS）からのCA}
\label{\detokenize{epics/rst/example1__httpRequest_to_Google:opi-macos-ca}}\begin{itemize}
\item {} 
同一ネットワークにLAN接続してある OPI(手元PC:macOS)からCA可能．

\item {} 
以下、IPアドレス/ポート番号の設定を環境変数にセット．

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} export EPICS\PYGZus{}CA\PYGZus{}ADDR\PYGZus{}LIST=\PYGZdq{}169.254.202.104:5064\PYGZdq{}


( e.g.1 \PYGZdl{} export EPICS\PYGZus{}CA\PYGZus{}ADDR\PYGZus{}LIST=\PYGZdq{}1.2.3.255 8.9.10.255\PYGZdq{} etc. )
or
( e.g.2 \PYGZdl{} export EPICS\PYGZus{}CA\PYGZus{}ADDR\PYGZus{}LIST=\PYGZdq{}1.1.1.1\PYGZdq{} and,  )
(       \PYGZdl{} export EPICS\PYGZus{}CA\PYGZus{}SERVER\PYGZus{}PORT=5064 etc.     )
\end{sphinxVerbatim}

\item {} 
コンソールからCA．

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} caget http:get
\end{sphinxVerbatim}

\item {} 
pyEpicsからCA．

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} python3
\PYGZgt{}\PYGZgt{}\PYGZgt{} import epics
\PYGZgt{}\PYGZgt{}\PYGZgt{} epics.caget( \PYGZdq{}http:get\PYGZdq{} )
\PYGZsq{}HTTP/1.1 200 OK\PYGZsq{}
\end{sphinxVerbatim}

\end{itemize}

\noindent{\hspace*{\fill}\sphinxincludegraphics[width=600\sphinxpxdimen]{{example1__httpRequest_test}.png}\hspace*{\fill}}
\begin{itemize}
\item {} 
OPIからIOCを介して、制御( HTTPリクエスト ) を実施することができた．

\end{itemize}


\subsection{参考URL}
\label{\detokenize{epics/rst/example1__httpRequest_to_Google:url}}\begin{itemize}
\item {} 
参考ノート： "\sphinxurl{https://note.com/dev\_associate/n/nfa4605c70f60}", "\sphinxurl{https://note.com/dev\_associate/n/nd886d700b10a}"

\item {} 
OPI/IOC通信時のポート番号、IPアドレスの設定 ( \sphinxurl{https://epics.anl.gov/EpicsDocumentation/AppDevManuals/ChannelAccess/cadoc\_4.htm} )

\end{itemize}


\section{基本動作例２： ArduinoのAD変換端子からの入力読取り}
\label{\detokenize{epics/rst/example2__arduino_ADConvertor:arduinoad}}\label{\detokenize{epics/rst/example2__arduino_ADConvertor::doc}}

\subsection{検証目標}
\label{\detokenize{epics/rst/example2__arduino_ADConvertor:id1}}\begin{itemize}
\item {} 
ハードウェア（Arduino）を遠隔制御する検証．

\end{itemize}


\subsection{前提条件}
\label{\detokenize{epics/rst/example2__arduino_ADConvertor:id2}}\begin{itemize}
\item {} 
IOCは \sphinxstylestrong{"RaspberryPi"} 、OPIは手元PCのmacOS、制御機器は \sphinxstylestrong{"Arduino Uno"} ．

\item {} 
Arduino\sphinxhyphen{}RaspberryPi間はUSB接続、RaspberryPi\sphinxhyphen{}mac間はLANケーブルで接続する．

\item {} 
Arduinoの5V\sphinxhyphen{}GND端子間に 1KΩ抵抗x2個、さらにLEDを直列に接続し、さらに抵抗の中間地点に Arduino A0端子を接続する．A0から、A/D変換(ADC)によってデジタル値に変換した値を読み取る．

\item {} 
制御モジュールとして、 \sphinxstylestrong{"StremDevice"} を使用する．

\item {} 
その他、 \sphinxstylestrong{asyn} , \sphinxstylestrong{"pyEpics"} を適宜使用する．

\item {} 
作業ディレクトリ： \$\{HOME\}/epics/app/simpleRead/  ( \$\{HOME\}=/home/epics/ )

\end{itemize}


\subsection{Arduinoプログラム（ADC )の転送}
\label{\detokenize{epics/rst/example2__arduino_ADConvertor:arduino-adc}}\begin{itemize}
\item {} 
Arduino プログラムは以下である．

\end{itemize}
\sphinxSetupCaptionForVerbatim{A Arduino program to measure the voltage between 2 registers.}
\def\sphinxLiteralBlockLabel{\label{\detokenize{epics/rst/example2__arduino_ADConvertor:id6}}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]

\PYG{c+c1}{// use A0\PYGZhy{}plug to check the voltage. //}
\PYG{c+c1}{//}
\PYG{c+c1}{// parameters                        //}

\PYG{k+kt}{int} \PYG{n}{analogPin}   \PYG{o}{=} \PYG{l+m+mi}{0}\PYG{p}{;}
\PYG{k+kt}{int} \PYG{n}{val}         \PYG{o}{=} \PYG{l+m+mi}{0}\PYG{p}{;}
\PYG{k+kt}{int} \PYG{n}{sampleRate}  \PYG{o}{=} \PYG{l+m+mi}{19200}\PYG{p}{;}
\PYG{k+kt}{int} \PYG{n}{interval\PYGZus{}ms} \PYG{o}{=} \PYG{l+m+mi}{1000}


\PYG{k+kt}{void} \PYG{n}{setup}\PYG{p}{(}\PYG{p}{)} \PYG{p}{\PYGZob{}}
   \PYG{n}{Serial}\PYG{p}{.}\PYG{n}{begin}\PYG{p}{(} \PYG{n}{sampleRate} \PYG{p}{)}\PYG{p}{;}
\PYG{p}{\PYGZcb{}}

\PYG{k+kt}{void} \PYG{n}{loop}\PYG{p}{(}\PYG{p}{)} \PYG{p}{\PYGZob{}}
  \PYG{n}{val} \PYG{o}{=} \PYG{n}{analogRead}\PYG{p}{(} \PYG{n}{analogPin} \PYG{p}{)}\PYG{p}{;}
  \PYG{n}{Serial}\PYG{p}{.}\PYG{n}{println}\PYG{p}{(}\PYG{n}{val}\PYG{p}{)}\PYG{p}{;}
  \PYG{n}{delay}\PYG{p}{(} \PYG{n}{interval\PYGZus{}ms} \PYG{p}{)}\PYG{p}{;}
\PYG{p}{\PYGZcb{}}
\end{sphinxVerbatim}
\begin{itemize}
\item {} 
上記プログラムは、\sphinxstylestrong{Arduino IDE} を使用してArduinoへ転送しておく．（手元PCからでも勿論、可）

\end{itemize}


\subsection{IOC構築}
\label{\detokenize{epics/rst/example2__arduino_ADConvertor:ioc}}

\subsubsection{IOC構築 / テスト の手順}
\label{\detokenize{epics/rst/example2__arduino_ADConvertor:id3}}\begin{itemize}
\item {} 
アプリ名は、参考URL（下記）に従い、simpleReadとする．

\item {} 
また、.dbやレコード名などは、全てsimpleReadへ統一する．

\item {} 
IOC\sphinxhyphen{}App 構築の手順は、以下である．
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxstylestrong{ベースアプリ} の作成．

\item {} 
\sphinxstylestrong{configure/RELEASE} に共有するモジュールのインストールパスを追記．

\item {} 
\sphinxstylestrong{"simpleReadApp"} 内の データベース情報、及び、コンパイル用のMakefileへ追記する．

\item {} 
\sphinxstylestrong{StreamDevice} 用の \sphinxstylestrong{プロトコル} を、 \sphinxstylestrong{protocols/simpleRead.proto} として作成する．

\item {} 
IOC初期化スクリプト( \sphinxstylestrong{iocBoot/iocsimpleRead/st.cmd} ) を編集し、実行可能とする．

\item {} 
make 、及び、st.cmdの実行、camonitorにより、経時変化を観察する．

\end{enumerate}

\end{itemize}

以下、上記手順について詳述する．


\subsubsection{1. ベースアプリの作成}
\label{\detokenize{epics/rst/example2__arduino_ADConvertor:id4}}\begin{itemize}
\item {} 
makeBaseApp.plを用いたベースアプリの作成

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} mkdir \PYGZhy{}p \PYGZti{}/epics/app/simpleRead
\PYGZdl{} cd  \PYGZti{}/epics/app/simpleRead
\PYGZdl{} makeBaseApp.pl \PYGZhy{}t ioc simpleRead
\PYGZdl{} makeBaseApp.pl \PYGZhy{}i \PYGZhy{}t ioc simpleRead
\end{sphinxVerbatim}

\end{itemize}


\subsubsection{2. 共通コンパイル設定事項の編集 ( configure/RELEASE )}
\label{\detokenize{epics/rst/example2__arduino_ADConvertor:configure-release}}\begin{itemize}
\item {} 
configure/RELEASEに、共通のコンパイル設定（モジュールの場所等、）を例えば以下のように記載する．

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{ASYN}   \PYG{o}{=} \PYG{o}{/}\PYG{n}{home}\PYG{o}{/}\PYG{n}{epics}\PYG{o}{/}\PYG{n}{epics}\PYG{o}{/}\PYG{n}{support}\PYG{o}{/}\PYG{n}{asyn}
\PYG{n}{STREAM} \PYG{o}{=} \PYG{o}{/}\PYG{n}{home}\PYG{o}{/}\PYG{n}{epics}\PYG{o}{/}\PYG{n}{epics}\PYG{o}{/}\PYG{n}{support}\PYG{o}{/}\PYG{n}{StreamDevice}
\end{sphinxVerbatim}

\end{itemize}


\subsubsection{3. データベースファイルとコンパイルの準備}
\label{\detokenize{epics/rst/example2__arduino_ADConvertor:id5}}\begin{itemize}
\item {} 
データベース及び使用するモジュールの情報を記載し、\$\{HOME\}/epics/app/simpleRead/simpleReadApp/Db/simpleRead.dbを作成する．
\sphinxSetupCaptionForVerbatim{simpleRead.db}
\def\sphinxLiteralBlockLabel{\label{\detokenize{epics/rst/example2__arduino_ADConvertor:id7}}}
\begin{sphinxVerbatim}[commandchars=\\\{\},numbers=left,firstnumber=1,stepnumber=1]
record\PYG{o}{(}longin,\PYG{l+s+s2}{\PYGZdq{}epics:simpleRead\PYGZdq{}}\PYG{o}{)}
\PYG{o}{\PYGZob{}}
  field\PYG{o}{(}DESC, \PYG{l+s+s2}{\PYGZdq{}A/D convertor raw input signal\PYGZdq{}} \PYG{o}{)}
  field\PYG{o}{(}DTYP, \PYG{l+s+s2}{\PYGZdq{}stream\PYGZdq{}}\PYG{o}{)}
  field\PYG{o}{(}INP, \PYG{l+s+s2}{\PYGZdq{}@simpleRead.proto getval PS1\PYGZdq{}}\PYG{o}{)}
  field\PYG{o}{(}SCAN, \PYG{l+s+s2}{\PYGZdq{}I/O Intr\PYGZdq{}}\PYG{o}{)}
\PYG{o}{\PYGZcb{}}
\end{sphinxVerbatim}

\item {} 
データベースのコンパイル対象として、上記の"simpleRead.db"を追加．

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{o}{@} \PYG{n}{simpleReadApp}\PYG{o}{/}\PYG{n}{Db}\PYG{o}{/}\PYG{n}{Makefile}

\PYG{n}{DB} \PYG{o}{+}\PYG{o}{=} \PYG{n}{simpleRead}\PYG{o}{.}\PYG{n}{db}
\end{sphinxVerbatim}

\item {} 
その他モジュールを利用する場合は、IOCの通信コードのコンパイルに使用するモジュール情報を、 "simpleReadApp/src/Makefile" に記載し、コンパイルできるようにする．

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{o}{@} \PYG{n}{simpleReadApp}\PYG{o}{/}\PYG{n}{src}\PYG{o}{/}\PYG{n}{Makefile}

\PYG{n}{simpleRead\PYGZus{}DBD}  \PYG{o}{+}\PYG{o}{=} \PYG{n}{stream}\PYG{o}{.}\PYG{n}{dbd}
\PYG{n}{simpleRead\PYGZus{}DBD}  \PYG{o}{+}\PYG{o}{=} \PYG{n}{asyn}\PYG{o}{.}\PYG{n}{dbd}
\PYG{n}{simpleRead\PYGZus{}DBD}  \PYG{o}{+}\PYG{o}{=} \PYG{n}{drvAsynSerialPort}\PYG{o}{.}\PYG{n}{dbd}

\PYG{n}{simpleRead\PYGZus{}LIBS} \PYG{o}{+}\PYG{o}{=} \PYG{n}{stream}
\PYG{n}{simpleRead\PYGZus{}LIBS} \PYG{o}{+}\PYG{o}{=} \PYG{n}{asyn}
\end{sphinxVerbatim}

\end{itemize}


\subsubsection{4. StreamDeviceの設定ファイル ( "protocol" )の作成}
\label{\detokenize{epics/rst/example2__arduino_ADConvertor:streamdevice-protocol}}\begin{itemize}
\item {} 
ディレクトリ "protocols"を作成し、StreamDeviceの入出力情報を記載する．

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} mkdir \PYGZdl{}HOME/epics/app/simpleRead/protocols
\end{sphinxVerbatim}
\sphinxSetupCaptionForVerbatim{simpleRead.proto}
\def\sphinxLiteralBlockLabel{\label{\detokenize{epics/rst/example2__arduino_ADConvertor:id8}}}
\begin{sphinxVerbatim}[commandchars=\\\{\},numbers=left,firstnumber=1,stepnumber=1]
\PYG{n+nv}{Terminator} \PYG{o}{=} CR LF\PYG{p}{;}

getVal\PYG{o}{\PYGZob{}}
  in \PYG{l+s+s2}{\PYGZdq{}\PYGZpc{}d\PYGZdq{}}\PYG{p}{;}
\PYG{o}{\PYGZcb{}}
\end{sphinxVerbatim}

\end{itemize}


\subsubsection{5. IOC 初期化スクリプト "st.cmd" の編集}
\label{\detokenize{epics/rst/example2__arduino_ADConvertor:ioc-st-cmd}}\begin{itemize}
\item {} 
IOC初期化スクリプト ( iocBoot/iocsimpleRead/st.cmd ) に、以下の情報を記載する．
\begin{quote}
\sphinxSetupCaptionForVerbatim{st.cmd}
\def\sphinxLiteralBlockLabel{\label{\detokenize{epics/rst/example2__arduino_ADConvertor:id9}}}
\fvset{hllines={, 14, 20, 24, 25,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+ch}{\PYGZsh{}!../../bin/linux\PYGZhy{}arm/simpleRead}

\PYG{c+c1}{\PYGZsh{}\PYGZhy{} You may have to change simpleRead to something else}
\PYG{c+c1}{\PYGZsh{}\PYGZhy{} everywhere it appears in this file}

\PYGZlt{} envPaths

\PYG{c+c1}{\PYGZsh{} \PYGZhy{}\PYGZhy{} n.k. added \PYGZhy{}\PYGZhy{} \PYGZsh{}}
epicsEnvSet\PYG{o}{(}\PYG{l+s+s2}{\PYGZdq{}STREAM\PYGZus{}PROTOCOL\PYGZus{}PATH\PYGZdq{}}, \PYG{l+s+s2}{\PYGZdq{}.:../../protocols\PYGZdq{}}\PYG{o}{)}

\PYG{n+nb}{cd} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+si}{\PYGZdl{}\PYGZob{}}\PYG{n+nv}{TOP}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}

\PYG{c+c1}{\PYGZsh{}\PYGZsh{} Register all support components}
dbLoadDatabase \PYG{l+s+s2}{\PYGZdq{}dbd/simpleRead.dbd\PYGZdq{}}
simpleRead\PYGZus{}registerRecordDeviceDriver pdbbase

\PYG{c+c1}{\PYGZsh{}\PYGZsh{} Load record instances}
\PYG{c+c1}{\PYGZsh{}dbLoadRecords(\PYGZdq{}db/xxx.db\PYGZdq{},\PYGZdq{}user=epics\PYGZdq{})}
\PYG{c+c1}{\PYGZsh{} \PYGZhy{}\PYGZhy{} n.k. added \PYGZhy{}\PYGZhy{} \PYGZsh{}}
dbLoadRecords \PYG{o}{(}\PYG{l+s+s2}{\PYGZdq{}db/simpleRead.db\PYGZdq{}}\PYG{o}{)}

\PYG{c+c1}{\PYGZsh{} drvGenericSerialConfigure( \PYGZdq{}PS1\PYGZdq{}, \PYGZdq{}/dev/ttyACM0\PYGZdq{} )}
\PYG{c+c1}{\PYGZsh{} asynSetPortOption( \PYGZdq{}PS1\PYGZdq{}, \PYGZdq{}baud\PYGZdq{}, \PYGZdq{}19200\PYGZdq{} )}
drvAsynSerialPortConfigure \PYG{o}{(}\PYG{l+s+s2}{\PYGZdq{}PS1\PYGZdq{}},\PYG{l+s+s2}{\PYGZdq{}/dev/ttyACM0\PYGZdq{}}\PYG{o}{)}
asynSetOption \PYG{o}{(}\PYG{l+s+s2}{\PYGZdq{}PS1\PYGZdq{}}, \PYG{l+m}{0}, \PYG{l+s+s2}{\PYGZdq{}baud\PYGZdq{}}, \PYG{l+s+s2}{\PYGZdq{}19200\PYGZdq{}}\PYG{o}{)}
\PYG{c+c1}{\PYGZsh{} \PYGZhy{}\PYGZhy{} n.k. added \PYGZhy{}\PYGZhy{} \PYGZsh{}}

\PYG{n+nb}{cd} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+si}{\PYGZdl{}\PYGZob{}}\PYG{n+nv}{TOP}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{/iocBoot/}\PYG{l+s+si}{\PYGZdl{}\PYGZob{}}\PYG{n+nv}{IOC}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}
iocInit

\PYG{c+c1}{\PYGZsh{}\PYGZsh{} Start any sequence programs}
\PYG{c+c1}{\PYGZsh{}seq sncxxx,\PYGZdq{}user=epics\PYGZdq{}}
\end{sphinxVerbatim}
\sphinxresetverbatimhllines

\begin{sphinxadmonition}{warning}{Warning:}
(隘路事項) dbLoadRecord, dbLoadDatabaseの順番が逆になったりすると、うまく動作しない．しかも、".db"ファイルの１行目がおかしいというエラーメッセージがでるので、ミスリーディングである．st.cmd前後の状態も確認すべきである．
\end{sphinxadmonition}
\end{quote}

\item {} 
スクリプトに実行権限を与えておく．

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} chmod u+x \PYGZdl{}HOME/epics/app/simpleRead/iocBoot/iocsimpleRead/st.cmd
\end{sphinxVerbatim}

\end{itemize}


\subsubsection{6. make 及び、初期化スクリプト "st.cmd" の実行}
\label{\detokenize{epics/rst/example2__arduino_ADConvertor:make-st-cmd}}\begin{itemize}
\item {} 
ベースディレクトリにて make する．

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} cd \PYGZdl{}HOME/epics/app/simpleRead/
\PYGZdl{} make distclean
\PYGZdl{} make
\end{sphinxVerbatim}

\item {} 
初期化スクリプトを実行する．

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} cd \PYGZdl{}HOME/epics/app/simpleRead/iocBoot/iocsimpleRead/
\PYGZdl{} sudo ./st.cmd
\end{sphinxVerbatim}

\item {} 
make 完了後の最終的なディレクトリツリーは以下．

\end{itemize}
\sphinxSetupCaptionForVerbatim{Directory tree after compilation.}
\def\sphinxLiteralBlockLabel{\label{\detokenize{epics/rst/example2__arduino_ADConvertor:id10}}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
epics@raspberrypi:\PYGZti{}/epics/app/simpleRead \PYGZdl{} tree
.
├── Makefile
├── bin
│   └── linux\PYGZhy{}arm
│       └── simpleRead
├── configure
│   ├── CONFIG
│   ├── CONFIG\PYGZus{}SITE
│   ├── Makefile
│   ├── O.Common
│   ├── O.linux\PYGZhy{}arm
│   │   └── Makefile
│   ├── RELEASE
│   ├── RULES
│   ├── RULES.ioc
│   ├── RULES\PYGZus{}DIRS
│   └── RULES\PYGZus{}TOP
├── db
│   └── simpleRead.db
├── dbd
│   └── simpleRead.dbd
├── iocBoot
│   ├── Makefile
│   └── iocsimpleRead
│       ├── Makefile
│       ├── envPaths
│       └── st.cmd
├── lib
│   └── linux\PYGZhy{}arm
├── protocols
│   └── simpleRead.proto
└── simpleReadApp
    ├── Db
    │   ├── Makefile
    │   ├── O.Common
    │   ├── O.linux\PYGZhy{}arm
    │   │   └── Makefile
    │   └── simpleRead.db
    ├── Makefile
    └── src
        ├── Makefile
        ├── O.Common
        │   └── simpleRead.dbd
        ├── O.linux\PYGZhy{}arm
        │   ├── Makefile
        │   ├── simpleRead
        │   ├── simpleRead.dbd.d
        │   ├── simpleReadMain.d
        │   ├── simpleReadMain.o
        │   ├── simpleRead\PYGZus{}registerRecordDeviceDriver.cpp
        │   ├── simpleRead\PYGZus{}registerRecordDeviceDriver.d
        │   └── simpleRead\PYGZus{}registerRecordDeviceDriver.o
        └── simpleReadMain.cpp

\PYG{l+m}{19} directories, \PYG{l+m}{33} files
epics@raspberrypi:\PYGZti{}/epics/app/simpleRead \PYGZdl{} 
\end{sphinxVerbatim}


\subsection{ADCの動作状況の確認}
\label{\detokenize{epics/rst/example2__arduino_ADConvertor:adc}}

\subsubsection{ローカルからのcamonitor}
\label{\detokenize{epics/rst/example2__arduino_ADConvertor:camonitor}}\begin{itemize}
\item {} 
別コンソールを立ち上げて、以下コマンドを実行

\begin{sphinxVerbatim}[commandchars=\\\{\}]
epics@raspberrypi: \PYGZti{} \PYGZdl{} camonitor epics:simpleRead
\end{sphinxVerbatim}

\end{itemize}


\subsubsection{OPI（手元macOS）からのCA}
\label{\detokenize{epics/rst/example2__arduino_ADConvertor:opi-macos-ca}}\begin{itemize}
\item {} 
pyEpicsからCA．

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} python3
\PYGZgt{}\PYGZgt{}\PYGZgt{} import epics
\PYGZgt{}\PYGZgt{}\PYGZgt{} epics.caget    ( \PYGZdq{}epics:simpleRead\PYGZdq{} )
\PYGZgt{}\PYGZgt{}\PYGZgt{} epics.camonitor( \PYGZdq{}epics:simpleRead\PYGZdq{} )
\end{sphinxVerbatim}

\item {} 
OPIからIOCを介して、制御( 電圧モニタ ) を実施することができた．

\end{itemize}


\subsection{参考URL}
\label{\detokenize{epics/rst/example2__arduino_ADConvertor:url}}\begin{itemize}
\item {} 
Arduino\sphinxhyphen{}EPICS サンプル ( KEK\sphinxhyphen{}EPICS Users JP, \sphinxurl{https://cerldev.kek.jp/trac/EpicsUsersJP/wiki/epics/arduino/simpleRead} )

\end{itemize}


\section{基本動作例３： EPICS\sphinxhyphen{}ArduinoによるLチカ (ON/OFF) 制御}
\label{\detokenize{epics/rst/example3__arduino_LEDcontrol01:epics-arduinol-on-off}}\label{\detokenize{epics/rst/example3__arduino_LEDcontrol01::doc}}

\subsection{検証目標}
\label{\detokenize{epics/rst/example3__arduino_LEDcontrol01:id1}}\begin{itemize}
\item {} 
ハードウェア（Arduino）の出力状態を遠隔制御する検証．

\end{itemize}


\subsection{前提条件}
\label{\detokenize{epics/rst/example3__arduino_LEDcontrol01:id2}}\begin{itemize}
\item {} 
IOCは \sphinxstylestrong{"RaspberryPi"} 、OPIは手元PCのmacOS、制御機器は \sphinxstylestrong{"Arduino Uno"} ．

\item {} 
Arduino\sphinxhyphen{}RaspberryPi間はUSB接続、RaspberryPi\sphinxhyphen{}mac間はLANケーブルで接続する．

\item {} 
Arduinoの２番端子\sphinxhyphen{}GND端子間に 1KΩ抵抗x2個、LEDを直列に接続する．２番端子の出力によってLEDを点灯させる．

\item {} 
制御モジュールとして、 \sphinxstylestrong{"StremDevice"} を使用し、その他、 \sphinxstylestrong{asyn} , \sphinxstylestrong{"pyEpics"} を適宜使用する．

\item {} 
作業ディレクトリ： \$\{HOME\}/epics/app/lightupLED/  ( \$\{HOME\}=/home/epics/ )

\end{itemize}


\subsection{Arduinoプログラム１：（Lチカ：ON/OFF制御）の転送}
\label{\detokenize{epics/rst/example3__arduino_LEDcontrol01:arduino1-l-on-off}}\begin{itemize}
\item {} 
シリアル制御（USB）から、ASCII文字を受け取り、文字に応じて以下の動作をする．
+ 文字が \sphinxstylestrong{"H"} ( ASCII:72 (10進数) ) であった場合LEDを \sphinxstylestrong{点灯} させる．
+ 文字が \sphinxstylestrong{"L"} ( ASCII:76 (10進数) ) であった場合LEDを \sphinxstylestrong{消灯} させる．

\item {} 
Arduino プログラムは以下である．

\item {} 
下記プログラムは、\sphinxstylestrong{Arduino IDE} を使用してArduinoへ転送しておく．（手元PCからでも勿論、可）

\end{itemize}
\sphinxSetupCaptionForVerbatim{arduino\_LEDcontrol01.ino}
\def\sphinxLiteralBlockLabel{\label{\detokenize{epics/rst/example3__arduino_LEDcontrol01:id6}}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]

\PYG{c+c1}{// program to control LED\PYGZsq{}s luminocity by PWM.}

\PYG{c+c1}{// parameters}
\PYG{k+kt}{int} \PYG{n}{pin\PYGZus{}LED}     \PYG{o}{=} \PYG{l+m+mi}{2}\PYG{p}{;}
\PYG{k+kt}{int} \PYG{n}{powerFactor} \PYG{o}{=} \PYG{l+m+mf}{0.0}\PYG{p}{;}
\PYG{k+kt}{int} \PYG{n}{serial\PYGZus{}bps}  \PYG{o}{=} \PYG{l+m+mi}{19200}\PYG{p}{;}
\PYG{k+kt}{int} \PYG{n}{ASCII\PYGZus{}H}     \PYG{o}{=} \PYG{l+m+mi}{72}\PYG{p}{;}
\PYG{k+kt}{int} \PYG{n}{ASCII\PYGZus{}L}     \PYG{o}{=} \PYG{l+m+mi}{76}\PYG{p}{;}

\PYG{k+kt}{void} \PYG{n+nf}{setup}\PYG{p}{(}\PYG{p}{)} \PYG{p}{\PYGZob{}}
  \PYG{c+c1}{// put your setup code here, to run once:}
  \PYG{n}{pinMode}\PYG{p}{(} \PYG{n}{pin\PYGZus{}LED}\PYG{p}{,} \PYG{n}{OUTPUT} \PYG{p}{)}\PYG{p}{;}
  \PYG{n}{Serial}\PYG{p}{.}\PYG{n}{begin}\PYG{p}{(} \PYG{n}{serial\PYGZus{}bps} \PYG{p}{)}\PYG{p}{;}
\PYG{p}{\PYGZcb{}}

\PYG{k+kt}{void} \PYG{n+nf}{loop}\PYG{p}{(}\PYG{p}{)} \PYG{p}{\PYGZob{}}
  \PYG{c+c1}{// put your main code here, to run repeatedly:}
  
  \PYG{k}{if} \PYG{p}{(} \PYG{n}{Serial}\PYG{p}{.}\PYG{n}{available}\PYG{p}{(}\PYG{p}{)} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{\PYGZob{}}
    \PYG{k+kt}{char} \PYG{n}{cRecv} \PYG{o}{=} \PYG{n}{Serial}\PYG{p}{.}\PYG{n}{read}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}

    \PYG{k}{if} \PYG{p}{(} \PYG{n}{cRecv} \PYG{o}{=}\PYG{o}{=} \PYG{n}{ASCII\PYGZus{}H} \PYG{p}{)}\PYG{p}{\PYGZob{}}
      \PYG{n}{digitalWrite}\PYG{p}{(} \PYG{n}{pin\PYGZus{}LED}\PYG{p}{,} \PYG{n}{HIGH} \PYG{p}{)}\PYG{p}{;}
    \PYG{p}{\PYGZcb{}}
    \PYG{k}{else} \PYG{k}{if} \PYG{p}{(} \PYG{n}{cRecv} \PYG{o}{=}\PYG{o}{=} \PYG{n}{ASCII\PYGZus{}L} \PYG{p}{)}\PYG{p}{\PYGZob{}}
      \PYG{n}{digitalWrite}\PYG{p}{(} \PYG{n}{pin\PYGZus{}LED}\PYG{p}{,} \PYG{n}{LOW}  \PYG{p}{)}\PYG{p}{;}
    \PYG{p}{\PYGZcb{}}
  \PYG{p}{\PYGZcb{}}
\PYG{p}{\PYGZcb{}} 
\end{sphinxVerbatim}
\begin{itemize}
\item {} 
pythonからの制御テストコードは以下である．

\end{itemize}
\sphinxSetupCaptionForVerbatim{test\_\_lightupLED.py}
\def\sphinxLiteralBlockLabel{\label{\detokenize{epics/rst/example3__arduino_LEDcontrol01:id7}}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} \PYGZhy{}*\PYGZhy{} coding: utf\PYGZhy{}8 \PYGZhy{}*\PYGZhy{}}
\PYG{k+kn}{import} \PYG{n+nn}{serial}

\PYG{n}{com\PYGZus{}num}   \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{/dev/cu.usbmodem142201}\PYG{l+s+s2}{\PYGZdq{}}
\PYG{n}{baud\PYGZus{}rate} \PYG{o}{=} \PYG{l+m+mi}{19200}

\PYG{k}{def} \PYG{n+nf}{main}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}

    \PYG{n}{ser} \PYG{o}{=} \PYG{n}{serial}\PYG{o}{.}\PYG{n}{Serial}\PYG{p}{(} \PYG{n}{com\PYGZus{}num}\PYG{p}{,} \PYG{n}{baud\PYGZus{}rate}\PYG{p}{,} \PYG{n}{timeout}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{k}{while} \PYG{k+kc}{True}\PYG{p}{:}

        \PYG{n+nb}{print}\PYG{p}{(} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{ input control command, ( }\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{H}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{:on, }\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{L}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{:off, }\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{E}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{:quit ) \PYGZgt{}\PYGZgt{}\PYGZgt{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{end}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZdq{}} \PYG{p}{)}
        \PYG{n}{str\PYGZus{}cmd}   \PYG{o}{=} \PYG{n+nb}{input}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{byte\PYGZus{}cmd}  \PYG{o}{=} \PYG{n+nb}{bytes}\PYG{p}{(} \PYG{n}{str\PYGZus{}cmd}\PYG{p}{,} \PYG{n}{encoding}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{ascii}\PYG{l+s+s2}{\PYGZdq{}} \PYG{p}{)}
        
        \PYG{k}{if} \PYG{p}{(} \PYG{n}{str\PYGZus{}cmd} \PYG{o}{==} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{E}\PYG{l+s+s2}{\PYGZdq{}} \PYG{p}{)}\PYG{p}{:} \PYG{k}{break}
        \PYG{n}{ser}\PYG{o}{.}\PYG{n}{write}\PYG{p}{(} \PYG{n}{byte\PYGZus{}cmd} \PYG{p}{)}
        
    \PYG{n}{ser}\PYG{o}{.}\PYG{n}{close}\PYG{p}{(}\PYG{p}{)}

\PYG{k}{if} \PYG{n+nv+vm}{\PYGZus{}\PYGZus{}name\PYGZus{}\PYGZus{}} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZus{}\PYGZus{}main\PYGZus{}\PYGZus{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
    \PYG{n}{main}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}


\subsection{IOC構築}
\label{\detokenize{epics/rst/example3__arduino_LEDcontrol01:ioc}}

\subsubsection{IOC構築 / テスト の手順}
\label{\detokenize{epics/rst/example3__arduino_LEDcontrol01:id3}}\begin{itemize}
\item {} 
アプリ名は、参考URL（下記）に従い、lightupLEDとする．

\item {} 
また、.dbやレコード名などは、全てlightupLEDへ統一する．

\item {} 
IOC\sphinxhyphen{}App 構築の手順は、以下である．
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxstylestrong{ベースアプリ} の作成．

\item {} 
\sphinxstylestrong{configure/RELEASE} に共有するモジュールのインストールパスを追記．

\item {} 
\sphinxstylestrong{"lightupLEDApp"} 内の データベース情報、及び、コンパイル用のMakefileへ追記する．

\item {} 
\sphinxstylestrong{StreamDevice} 用の \sphinxstylestrong{プロトコル} を、 \sphinxstylestrong{protocols/lightupLED.proto} として作成する．

\item {} 
IOC初期化スクリプト( \sphinxstylestrong{iocBoot/ioclightupLED/st.cmd} ) を編集し、実行可能とする．

\item {} 
make 、及び、st.cmdの実行、camonitorにより、経時変化を観察する．

\end{enumerate}

\end{itemize}

以下、上記手順について詳述する．


\subsubsection{1. ベースアプリの作成}
\label{\detokenize{epics/rst/example3__arduino_LEDcontrol01:id4}}\begin{itemize}
\item {} 
makeBaseApp.plを用いたベースアプリの作成

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} mkdir \PYGZhy{}p \PYGZti{}/epics/app/lightupLED
\PYGZdl{} cd  \PYGZti{}/epics/app/lightupLED
\PYGZdl{} makeBaseApp.pl \PYGZhy{}t ioc lightupLED
\PYGZdl{} makeBaseApp.pl \PYGZhy{}i \PYGZhy{}t ioc lightupLED
\end{sphinxVerbatim}

\end{itemize}


\subsubsection{2. 共通コンパイル設定事項の編集 ( configure/RELEASE )}
\label{\detokenize{epics/rst/example3__arduino_LEDcontrol01:configure-release}}\begin{itemize}
\item {} 
configure/RELEASEに、共通のコンパイル設定（モジュールの場所等、）を例えば以下のように記載する．

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{ASYN}   \PYG{o}{=} \PYG{o}{/}\PYG{n}{home}\PYG{o}{/}\PYG{n}{epics}\PYG{o}{/}\PYG{n}{epics}\PYG{o}{/}\PYG{n}{support}\PYG{o}{/}\PYG{n}{asyn}
\PYG{n}{STREAM} \PYG{o}{=} \PYG{o}{/}\PYG{n}{home}\PYG{o}{/}\PYG{n}{epics}\PYG{o}{/}\PYG{n}{epics}\PYG{o}{/}\PYG{n}{support}\PYG{o}{/}\PYG{n}{StreamDevice}
\end{sphinxVerbatim}

\end{itemize}


\subsubsection{3. データベースファイルとコンパイルの準備}
\label{\detokenize{epics/rst/example3__arduino_LEDcontrol01:id5}}\begin{itemize}
\item {} 
データベース及び使用するモジュールの情報を記載し、\$\{HOME\}/epics/app/lightupLED/lightupLEDApp/Db/lightupLED.dbを作成する．
\sphinxSetupCaptionForVerbatim{lightupLED.db}
\def\sphinxLiteralBlockLabel{\label{\detokenize{epics/rst/example3__arduino_LEDcontrol01:id8}}}
\begin{sphinxVerbatim}[commandchars=\\\{\},numbers=left,firstnumber=1,stepnumber=1]
record\PYG{o}{(} stringout, \PYG{l+s+s2}{\PYGZdq{}epics:lightupLED\PYGZdq{}} \PYG{o}{)}
\PYG{o}{\PYGZob{}}
  field\PYG{o}{(} DESC, \PYG{l+s+s2}{\PYGZdq{}var to light up LEDs\PYGZdq{}} \PYG{o}{)}
  field\PYG{o}{(} DTYP, \PYG{l+s+s2}{\PYGZdq{}stream\PYGZdq{}} \PYG{o}{)}
  field\PYG{o}{(} OUT , \PYG{l+s+s2}{\PYGZdq{}@lightupLED.proto putval PS1\PYGZdq{}} \PYG{o}{)}
\PYG{o}{\PYGZcb{}}
\end{sphinxVerbatim}

\item {} 
データベースのコンパイル対象として、上記の"lightupLED.db"を追加．

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{o}{@} \PYG{n}{lightupLEDApp}\PYG{o}{/}\PYG{n}{Db}\PYG{o}{/}\PYG{n}{Makefile}

\PYG{n}{DB} \PYG{o}{+}\PYG{o}{=} \PYG{n}{lightupLED}\PYG{o}{.}\PYG{n}{db}
\end{sphinxVerbatim}

\item {} 
その他モジュールを利用する場合は、IOCの通信コードのコンパイルに使用するモジュール情報を、 "lightupLEDApp/src/Makefile" に記載し、コンパイルできるようにする．

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{o}{@} \PYG{n}{lightupLEDApp}\PYG{o}{/}\PYG{n}{src}\PYG{o}{/}\PYG{n}{Makefile}

\PYG{n}{lightupLED\PYGZus{}DBD}  \PYG{o}{+}\PYG{o}{=} \PYG{n}{stream}\PYG{o}{.}\PYG{n}{dbd}
\PYG{n}{lightupLED\PYGZus{}DBD}  \PYG{o}{+}\PYG{o}{=} \PYG{n}{asyn}\PYG{o}{.}\PYG{n}{dbd}
\PYG{n}{lightupLED\PYGZus{}DBD}  \PYG{o}{+}\PYG{o}{=} \PYG{n}{drvAsynSerialPort}\PYG{o}{.}\PYG{n}{dbd}

\PYG{n}{lightupLED\PYGZus{}LIBS} \PYG{o}{+}\PYG{o}{=} \PYG{n}{stream}
\PYG{n}{lightupLED\PYGZus{}LIBS} \PYG{o}{+}\PYG{o}{=} \PYG{n}{asyn}
\end{sphinxVerbatim}

\end{itemize}


\subsubsection{4. StreamDeviceの設定ファイル ( "protocol" )の作成}
\label{\detokenize{epics/rst/example3__arduino_LEDcontrol01:streamdevice-protocol}}\begin{itemize}
\item {} 
ディレクトリ "protocols"を作成し、StreamDeviceの入出力情報を記載する．

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} mkdir \PYGZdl{}HOME/epics/app/lightupLED/protocols
\end{sphinxVerbatim}
\sphinxSetupCaptionForVerbatim{lightupLED.proto}
\def\sphinxLiteralBlockLabel{\label{\detokenize{epics/rst/example3__arduino_LEDcontrol01:id9}}}
\begin{sphinxVerbatim}[commandchars=\\\{\},numbers=left,firstnumber=1,stepnumber=1]
\PYG{n+nv}{Terminator} \PYG{o}{=} CR LF\PYG{p}{;}

putval\PYG{o}{\PYGZob{}}
  out \PYG{l+s+s2}{\PYGZdq{}\PYGZpc{}s\PYGZdq{}}\PYG{p}{;}
\PYG{o}{\PYGZcb{}}
\end{sphinxVerbatim}

\end{itemize}


\subsubsection{5. IOC 初期化スクリプト "st.cmd" の編集}
\label{\detokenize{epics/rst/example3__arduino_LEDcontrol01:ioc-st-cmd}}\begin{itemize}
\item {} 
IOC初期化スクリプト ( iocBoot/ioclightupLED/st.cmd ) に、以下の情報を記載する．
\begin{quote}
\sphinxSetupCaptionForVerbatim{st.cmd}
\def\sphinxLiteralBlockLabel{\label{\detokenize{epics/rst/example3__arduino_LEDcontrol01:id10}}}
\fvset{hllines={, 14, 20, 24, 25,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+ch}{\PYGZsh{}!../../bin/linux\PYGZhy{}arm/lightupLED}

\PYG{c+c1}{\PYGZsh{}\PYGZhy{} You may have to change lightupLED to something else}
\PYG{c+c1}{\PYGZsh{}\PYGZhy{} everywhere it appears in this file}

\PYGZlt{} envPaths
\PYG{c+c1}{\PYGZsh{} \PYGZhy{}\PYGZhy{} n.k. \PYGZhy{}\PYGZhy{} \PYGZsh{}}
epicsEnvSet\PYG{o}{(}\PYG{l+s+s2}{\PYGZdq{}STREAM\PYGZus{}PROTOCOL\PYGZus{}PATH\PYGZdq{}}, \PYG{l+s+s2}{\PYGZdq{}.:../../protocols\PYGZdq{}}\PYG{o}{)}

\PYG{n+nb}{cd} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+si}{\PYGZdl{}\PYGZob{}}\PYG{n+nv}{TOP}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}

\PYG{c+c1}{\PYGZsh{}\PYGZsh{} Register all support components}
dbLoadDatabase \PYG{l+s+s2}{\PYGZdq{}dbd/lightupLED.dbd\PYGZdq{}}
lightupLED\PYGZus{}registerRecordDeviceDriver pdbbase

\PYG{c+c1}{\PYGZsh{}\PYGZsh{} Load record instances}
\PYG{c+c1}{\PYGZsh{}dbLoadRecords(\PYGZdq{}db/xxx.db\PYGZdq{},\PYGZdq{}user=epics\PYGZdq{})}

\PYG{c+c1}{\PYGZsh{} \PYGZhy{}\PYGZhy{} n.k. \PYGZhy{}\PYGZhy{} \PYGZsh{}}
dbLoadRecords\PYG{o}{(} \PYG{l+s+s2}{\PYGZdq{}db/lightupLED.db\PYGZdq{}} \PYG{o}{)}
drvAsynSerialPortConfigure \PYG{o}{(}\PYG{l+s+s2}{\PYGZdq{}PS1\PYGZdq{}},\PYG{l+s+s2}{\PYGZdq{}/dev/ttyACM0\PYGZdq{}}\PYG{o}{)}
asynSetOption\PYG{o}{(} \PYG{l+s+s2}{\PYGZdq{}PS1\PYGZdq{}}, \PYG{l+m}{0}, \PYG{l+s+s2}{\PYGZdq{}baud\PYGZdq{}}, \PYG{l+s+s2}{\PYGZdq{}19200\PYGZdq{}} \PYG{o}{)}

\PYG{n+nb}{cd} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+si}{\PYGZdl{}\PYGZob{}}\PYG{n+nv}{TOP}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{/iocBoot/}\PYG{l+s+si}{\PYGZdl{}\PYGZob{}}\PYG{n+nv}{IOC}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}
iocInit

\PYG{c+c1}{\PYGZsh{}\PYGZsh{} Start any sequence programs}
\PYG{c+c1}{\PYGZsh{}seq sncxxx,\PYGZdq{}user=epics\PYGZdq{}}
\end{sphinxVerbatim}
\sphinxresetverbatimhllines

\begin{sphinxadmonition}{warning}{Warning:}
(隘路事項) dbLoadRecord, dbLoadDatabaseの順番が逆になったりすると、うまく動作しない．しかも、".db"ファイルの１行目がおかしいというエラーメッセージがでるので、ミスリーディングである．st.cmd前後の状態も確認すべきである．
\end{sphinxadmonition}
\end{quote}

\item {} 
スクリプトに実行権限を与えておく．

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} chmod u+x \PYGZdl{}HOME/epics/app/lightupLED/iocBoot/ioclightupLED/st.cmd
\end{sphinxVerbatim}

\end{itemize}


\subsubsection{6. make 及び、初期化スクリプト "st.cmd" の実行}
\label{\detokenize{epics/rst/example3__arduino_LEDcontrol01:make-st-cmd}}\begin{itemize}
\item {} 
ベースディレクトリにて make する．

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} cd \PYGZdl{}HOME/epics/app/lightupLED/
\PYGZdl{} make distclean
\PYGZdl{} make
\end{sphinxVerbatim}

\item {} 
初期化スクリプトを実行する．

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} cd \PYGZdl{}HOME/epics/app/lightupLED/iocBoot/ioclightupLED/
\PYGZdl{} sudo ./st.cmd
\end{sphinxVerbatim}

\end{itemize}


\subsection{ADCの動作状況の確認}
\label{\detokenize{epics/rst/example3__arduino_LEDcontrol01:adc}}

\subsubsection{ローカルからのcamonitor}
\label{\detokenize{epics/rst/example3__arduino_LEDcontrol01:camonitor}}\begin{itemize}
\item {} 
別コンソールを立ち上げて、以下コマンドを実行

\begin{sphinxVerbatim}[commandchars=\\\{\}]
epics@raspberrypi: \PYGZti{} \PYGZdl{} caput epics:lightupLED \PYGZdq{}H\PYGZdq{}      ( H も可 )
\end{sphinxVerbatim}

\end{itemize}


\subsubsection{OPI（手元macOS）からのCA}
\label{\detokenize{epics/rst/example3__arduino_LEDcontrol01:opi-macos-ca}}\begin{itemize}
\item {} 
pyEpicsからCA．

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} python3
\PYGZgt{}\PYGZgt{}\PYGZgt{} import epics
\PYGZgt{}\PYGZgt{}\PYGZgt{} epics.caput( \PYGZdq{}epics:lightupLED\PYGZdq{}, \PYGZdq{}H\PYGZdq{} )
\end{sphinxVerbatim}

\item {} 
OPIからIOCを介して、 \sphinxstylestrong{"Lチカ"} を実施することができた．

\end{itemize}


\subsection{参考URL}
\label{\detokenize{epics/rst/example3__arduino_LEDcontrol01:url}}\begin{itemize}
\item {} 
Arduino\sphinxhyphen{}EPICS サンプル ( KEK\sphinxhyphen{}EPICS Users JP, \sphinxurl{https://cerldev.kek.jp/trac/EpicsUsersJP/wiki/epics/arduino/simpleRead} )

\item {} 
Github:inigoalonso/setup\sphinxhyphen{}epics\sphinxhyphen{}serial\sphinxhyphen{}arduino ( arduino\sphinxhyphen{}EPICS  https://gist.github.com/inigoalonso/99d9076c672661a4b821 )

\item {} 
StreamDevice \sphinxhyphen{}protocol Files\sphinxhyphen{} ( \sphinxurl{https://paulscherrerinstitute.github.io/StreamDevice/protocol.html} )

\end{itemize}


\section{基本動作例４： EPICS\sphinxhyphen{}Arduinoによる LED\sphinxhyphen{}PWM 調光制御}
\label{\detokenize{epics/rst/example4__arduino_LEDcontrol02:epics-arduino-led-pwm}}\label{\detokenize{epics/rst/example4__arduino_LEDcontrol02::doc}}

\subsection{検証目標}
\label{\detokenize{epics/rst/example4__arduino_LEDcontrol02:id1}}\begin{itemize}
\item {} 
ハードウェア（Arduino）の出力状態をPWM制御する検証．

\end{itemize}


\subsection{前提条件}
\label{\detokenize{epics/rst/example4__arduino_LEDcontrol02:id2}}\begin{itemize}
\item {} 
前回同様．

\item {} 
PWMでLEDを調光する．

\end{itemize}


\subsection{Arduinoプログラム：（PWM 制御）の転送}
\label{\detokenize{epics/rst/example4__arduino_LEDcontrol02:arduino-pwm}}\begin{itemize}
\item {} 
シリアル制御（USB）から、明るさ信号を送信し、PWM制御する．

\item {} 
Arduino プログラムは以下である．

\end{itemize}
\sphinxSetupCaptionForVerbatim{arduino\_LEDcontrol\_02.ino}
\def\sphinxLiteralBlockLabel{\label{\detokenize{epics/rst/example4__arduino_LEDcontrol02:id6}}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]

\PYG{c+c1}{// arduino PWM output program //}

\PYG{k+kt}{int}    \PYG{n}{pin\PYGZus{}LED}    \PYG{o}{=} \PYG{l+m+mi}{5}\PYG{p}{;}
\PYG{k+kt}{int}    \PYG{n}{usb\PYGZus{}bpm}    \PYG{o}{=} \PYG{l+m+mi}{19200}\PYG{p}{;}

\PYG{k+kt}{void} \PYG{n+nf}{setup}\PYG{p}{(}\PYG{p}{)} \PYG{p}{\PYGZob{}}
  \PYG{c+c1}{// put your setup code here, to run once:}
  \PYG{n}{pinMode}\PYG{p}{(} \PYG{n}{pin\PYGZus{}LED}\PYG{p}{,} \PYG{n}{OUTPUT} \PYG{p}{)}\PYG{p}{;}
  \PYG{n}{Serial}\PYG{p}{.}\PYG{n}{begin}\PYG{p}{(} \PYG{n}{usb\PYGZus{}bpm} \PYG{p}{)}\PYG{p}{;}
\PYG{p}{\PYGZcb{}}

\PYG{k+kt}{void} \PYG{n+nf}{loop}\PYG{p}{(}\PYG{p}{)} \PYG{p}{\PYGZob{}}
  \PYG{c+c1}{// put your main code here, to run repeatedly:}
  
  \PYG{k}{if} \PYG{p}{(} \PYG{n}{Serial}\PYG{p}{.}\PYG{n}{available}\PYG{p}{(}\PYG{p}{)} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0} \PYG{p}{)}\PYG{p}{\PYGZob{}}
    \PYG{k+kt}{int} \PYG{n}{iRecv} \PYG{o}{=} \PYG{n}{Serial}\PYG{p}{.}\PYG{n}{parseInt}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
    \PYG{k}{if} \PYG{p}{(} \PYG{n}{iRecv} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{255} \PYG{p}{)}\PYG{p}{\PYGZob{}}
      \PYG{n}{iRecv} \PYG{o}{=} \PYG{l+m+mi}{255}\PYG{p}{;}
    \PYG{p}{\PYGZcb{}} \PYG{k}{else} \PYG{k}{if} \PYG{p}{(} \PYG{n}{iRecv} \PYG{o}{\PYGZlt{}} \PYG{l+m+mi}{0} \PYG{p}{)}\PYG{p}{\PYGZob{}}
      \PYG{n}{iRecv} \PYG{o}{=} \PYG{l+m+mi}{0}\PYG{p}{;}
    \PYG{p}{\PYGZcb{}}
    \PYG{n}{analogWrite}\PYG{p}{(} \PYG{n}{pin\PYGZus{}LED}\PYG{p}{,} \PYG{n}{iRecv} \PYG{p}{)}\PYG{p}{;}
  \PYG{p}{\PYGZcb{}}
\PYG{p}{\PYGZcb{}}
\end{sphinxVerbatim}
\begin{itemize}
\item {} 
pythonからの制御テストコードは以下である．

\end{itemize}
\sphinxSetupCaptionForVerbatim{test\_\_pwmLED.py}
\def\sphinxLiteralBlockLabel{\label{\detokenize{epics/rst/example4__arduino_LEDcontrol02:id7}}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} \PYGZhy{}*\PYGZhy{} coding: utf\PYGZhy{}8 \PYGZhy{}*\PYGZhy{}}
\PYG{k+kn}{import} \PYG{n+nn}{serial}

\PYG{n}{com\PYGZus{}num}   \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{/dev/cu.usbmodem142201}\PYG{l+s+s2}{\PYGZdq{}}
\PYG{n}{baud\PYGZus{}rate} \PYG{o}{=} \PYG{l+m+mi}{19200}

\PYG{k}{def} \PYG{n+nf}{main}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}

    \PYG{n}{ser} \PYG{o}{=} \PYG{n}{serial}\PYG{o}{.}\PYG{n}{Serial}\PYG{p}{(} \PYG{n}{com\PYGZus{}num}\PYG{p}{,} \PYG{n}{baud\PYGZus{}rate}\PYG{p}{,} \PYG{n}{timeout}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{k}{while} \PYG{k+kc}{True}\PYG{p}{:}

        \PYG{n+nb}{print}\PYG{p}{(} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{ input PWM control value ( 0 \PYGZlt{} val \PYGZlt{} 255, or type quit ) \PYGZgt{}\PYGZgt{}\PYGZgt{} }\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{end}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZdq{}} \PYG{p}{)}
        \PYG{n}{int\PYGZus{}cmd}   \PYG{o}{=} \PYG{n+nb}{input}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{byte\PYGZus{}cmd}  \PYG{o}{=} \PYG{n+nb}{bytes}\PYG{p}{(} \PYG{n}{int\PYGZus{}cmd}\PYG{p}{,} \PYG{n}{encoding}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{ascii}\PYG{l+s+s2}{\PYGZdq{}} \PYG{p}{)}
        
        \PYG{k}{if} \PYG{p}{(} \PYG{n}{int\PYGZus{}cmd} \PYG{o}{==} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{quit}\PYG{l+s+s2}{\PYGZdq{}} \PYG{p}{)}\PYG{p}{:} \PYG{k}{break}
        \PYG{n}{ser}\PYG{o}{.}\PYG{n}{write}\PYG{p}{(} \PYG{n}{byte\PYGZus{}cmd} \PYG{p}{)}
        
    \PYG{n}{ser}\PYG{o}{.}\PYG{n}{close}\PYG{p}{(}\PYG{p}{)}

\PYG{k}{if} \PYG{n+nv+vm}{\PYGZus{}\PYGZus{}name\PYGZus{}\PYGZus{}} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZus{}\PYGZus{}main\PYGZus{}\PYGZus{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
    \PYG{n}{main}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}


\subsection{IOC構築}
\label{\detokenize{epics/rst/example4__arduino_LEDcontrol02:ioc}}

\subsubsection{IOC構築 / テスト の手順}
\label{\detokenize{epics/rst/example4__arduino_LEDcontrol02:id3}}\begin{itemize}
\item {} 
アプリ名は、参考URL（下記）に従い、pwmLEDとする．

\item {} 
また、.dbやレコード名などは、全てpwmLEDへ統一する．

\item {} 
IOC\sphinxhyphen{}App 構築の手順は、以下である．
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxstylestrong{ベースアプリ} の作成．

\item {} 
\sphinxstylestrong{configure/RELEASE} に共有するモジュールのインストールパスを追記．

\item {} 
\sphinxstylestrong{"pwmLEDApp"} 内の データベース情報、及び、コンパイル用のMakefileへ追記する．

\item {} 
\sphinxstylestrong{StreamDevice} 用の \sphinxstylestrong{プロトコル} を、 \sphinxstylestrong{protocols/pwmLED.proto} として作成する．

\item {} 
IOC初期化スクリプト( \sphinxstylestrong{iocBoot/iocpwmLED/st.cmd} ) を編集し、実行可能とする．

\item {} 
make 、及び、st.cmdの実行、camonitorにより、経時変化を観察する．

\end{enumerate}

\end{itemize}

以下、上記手順について詳述する．


\subsubsection{1. ベースアプリの作成}
\label{\detokenize{epics/rst/example4__arduino_LEDcontrol02:id4}}\begin{itemize}
\item {} 
makeBaseApp.plを用いたベースアプリの作成

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} mkdir \PYGZhy{}p \PYGZti{}/epics/app/pwmLED
\PYGZdl{} cd  \PYGZti{}/epics/app/pwmLED
\PYGZdl{} makeBaseApp.pl \PYGZhy{}t ioc pwmLED
\PYGZdl{} makeBaseApp.pl \PYGZhy{}i \PYGZhy{}t ioc pwmLED
\end{sphinxVerbatim}

\end{itemize}


\subsubsection{2. 共通コンパイル設定事項の編集 ( configure/RELEASE )}
\label{\detokenize{epics/rst/example4__arduino_LEDcontrol02:configure-release}}\begin{itemize}
\item {} 
configure/RELEASEに、共通のコンパイル設定（モジュールの場所等、）を例えば以下のように記載する．

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{ASYN}   \PYG{o}{=} \PYG{o}{/}\PYG{n}{home}\PYG{o}{/}\PYG{n}{epics}\PYG{o}{/}\PYG{n}{epics}\PYG{o}{/}\PYG{n}{support}\PYG{o}{/}\PYG{n}{asyn}
\PYG{n}{STREAM} \PYG{o}{=} \PYG{o}{/}\PYG{n}{home}\PYG{o}{/}\PYG{n}{epics}\PYG{o}{/}\PYG{n}{epics}\PYG{o}{/}\PYG{n}{support}\PYG{o}{/}\PYG{n}{StreamDevice}
\end{sphinxVerbatim}

\end{itemize}


\subsubsection{3. データベースファイルとコンパイルの準備}
\label{\detokenize{epics/rst/example4__arduino_LEDcontrol02:id5}}\begin{itemize}
\item {} 
データベース及び使用するモジュールの情報を記載し、\$\{HOME\}/epics/app/pwmLED/pwmLEDApp/Db/pwmLED.dbを作成する．
\sphinxSetupCaptionForVerbatim{pwmLED.db}
\def\sphinxLiteralBlockLabel{\label{\detokenize{epics/rst/example4__arduino_LEDcontrol02:id8}}}
\begin{sphinxVerbatim}[commandchars=\\\{\},numbers=left,firstnumber=1,stepnumber=1]
record\PYG{o}{(} stringout, \PYG{l+s+s2}{\PYGZdq{}epics:pwmLED\PYGZdq{}} \PYG{o}{)}
\PYG{o}{\PYGZob{}}
  field\PYG{o}{(} DESC, \PYG{l+s+s2}{\PYGZdq{}pwm of LED\PYGZdq{}} \PYG{o}{)}
  field\PYG{o}{(} DTYP, \PYG{l+s+s2}{\PYGZdq{}stream\PYGZdq{}} \PYG{o}{)}
  field\PYG{o}{(} OUT , \PYG{l+s+s2}{\PYGZdq{}@pwmLED.proto putval PS1\PYGZdq{}}\PYG{o}{)}
  field\PYG{o}{(} SCAN, \PYG{l+s+s2}{\PYGZdq{}I/O Intr\PYGZdq{}} \PYG{o}{)}
\PYG{o}{\PYGZcb{}}
\end{sphinxVerbatim}

\item {} 
データベースのコンパイル対象として、上記の"pwmLED.db"を追加．

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{o}{@} \PYG{n}{pwmLEDApp}\PYG{o}{/}\PYG{n}{Db}\PYG{o}{/}\PYG{n}{Makefile}

\PYG{n}{DB} \PYG{o}{+}\PYG{o}{=} \PYG{n}{pwmLED}\PYG{o}{.}\PYG{n}{db}
\end{sphinxVerbatim}

\item {} 
その他モジュールを利用する場合は、IOCの通信コードのコンパイルに使用するモジュール情報を、 "pwmLEDApp/src/Makefile" に記載し、コンパイルできるようにする．

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{o}{@} \PYG{n}{pwmLEDApp}\PYG{o}{/}\PYG{n}{src}\PYG{o}{/}\PYG{n}{Makefile}

\PYG{n}{pwmLED\PYGZus{}DBD}  \PYG{o}{+}\PYG{o}{=} \PYG{n}{stream}\PYG{o}{.}\PYG{n}{dbd}
\PYG{n}{pwmLED\PYGZus{}DBD}  \PYG{o}{+}\PYG{o}{=} \PYG{n}{asyn}\PYG{o}{.}\PYG{n}{dbd}
\PYG{n}{pwmLED\PYGZus{}DBD}  \PYG{o}{+}\PYG{o}{=} \PYG{n}{drvAsynSerialPort}\PYG{o}{.}\PYG{n}{dbd}

\PYG{n}{pwmLED\PYGZus{}LIBS} \PYG{o}{+}\PYG{o}{=} \PYG{n}{stream}
\PYG{n}{pwmLED\PYGZus{}LIBS} \PYG{o}{+}\PYG{o}{=} \PYG{n}{asyn}
\end{sphinxVerbatim}

\end{itemize}


\subsubsection{4. StreamDeviceの設定ファイル ( "protocol" )の作成}
\label{\detokenize{epics/rst/example4__arduino_LEDcontrol02:streamdevice-protocol}}\begin{itemize}
\item {} 
ディレクトリ "protocols"を作成し、StreamDeviceの入出力情報を記載する．

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} mkdir \PYGZdl{}HOME/epics/app/pwmLED/protocols
\end{sphinxVerbatim}
\sphinxSetupCaptionForVerbatim{pwmLED.proto}
\def\sphinxLiteralBlockLabel{\label{\detokenize{epics/rst/example4__arduino_LEDcontrol02:id9}}}
\begin{sphinxVerbatim}[commandchars=\\\{\},numbers=left,firstnumber=1,stepnumber=1]
\PYG{n+nv}{Terminator} \PYG{o}{=} CR LF\PYG{p}{;}

putval\PYG{o}{\PYGZob{}}
  out \PYG{l+s+s2}{\PYGZdq{}\PYGZpc{}s\PYGZdq{}}\PYG{p}{;}
\PYG{o}{\PYGZcb{}}
\end{sphinxVerbatim}

\end{itemize}


\subsubsection{5. IOC 初期化スクリプト "st.cmd" の編集}
\label{\detokenize{epics/rst/example4__arduino_LEDcontrol02:ioc-st-cmd}}\begin{itemize}
\item {} 
IOC初期化スクリプト ( iocBoot/iocpwmLED/st.cmd ) に、以下の情報を記載する．
\begin{quote}
\sphinxSetupCaptionForVerbatim{st.cmd}
\def\sphinxLiteralBlockLabel{\label{\detokenize{epics/rst/example4__arduino_LEDcontrol02:id10}}}
\fvset{hllines={, 14, 20, 24, 25,}}%
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+ch}{\PYGZsh{}!../../bin/linux\PYGZhy{}arm/pwmLED}

\PYG{c+c1}{\PYGZsh{}\PYGZhy{} You may have to change pwmLED to something else}
\PYG{c+c1}{\PYGZsh{}\PYGZhy{} everywhere it appears in this file}

\PYGZlt{} envPaths
epicsEnvSet\PYG{o}{(}\PYG{l+s+s2}{\PYGZdq{}STREAM\PYGZus{}PROTOCOL\PYGZus{}PATH\PYGZdq{}}, \PYG{l+s+s2}{\PYGZdq{}.:../../protocols\PYGZdq{}}\PYG{o}{)}

\PYG{n+nb}{cd} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+si}{\PYGZdl{}\PYGZob{}}\PYG{n+nv}{TOP}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}

\PYG{c+c1}{\PYGZsh{}\PYGZsh{} Register all support components}
dbLoadDatabase \PYG{l+s+s2}{\PYGZdq{}dbd/pwmLED.dbd\PYGZdq{}}
pwmLED\PYGZus{}registerRecordDeviceDriver pdbbase

\PYG{c+c1}{\PYGZsh{}\PYGZsh{} Load record instances}
\PYG{c+c1}{\PYGZsh{}dbLoadRecords(\PYGZdq{}db/xxx.db\PYGZdq{},\PYGZdq{}user=epics\PYGZdq{})}

dbLoadRecords\PYG{o}{(} \PYG{l+s+s2}{\PYGZdq{}db/pwmLED.db\PYGZdq{}} \PYG{o}{)}
drvAsynSerialPortConfigure \PYG{o}{(}\PYG{l+s+s2}{\PYGZdq{}PS1\PYGZdq{}},\PYG{l+s+s2}{\PYGZdq{}/dev/ttyACM0\PYGZdq{}}\PYG{o}{)}
asynSetOption\PYG{o}{(} \PYG{l+s+s2}{\PYGZdq{}PS1\PYGZdq{}}, \PYG{l+m}{0}, \PYG{l+s+s2}{\PYGZdq{}baud\PYGZdq{}}, \PYG{l+s+s2}{\PYGZdq{}19200\PYGZdq{}} \PYG{o}{)}


\PYG{n+nb}{cd} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+si}{\PYGZdl{}\PYGZob{}}\PYG{n+nv}{TOP}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{/iocBoot/}\PYG{l+s+si}{\PYGZdl{}\PYGZob{}}\PYG{n+nv}{IOC}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}
iocInit

\PYG{c+c1}{\PYGZsh{}\PYGZsh{} Start any sequence programs}
\PYG{c+c1}{\PYGZsh{}seq sncxxx,\PYGZdq{}user=epics\PYGZdq{}}
\end{sphinxVerbatim}
\sphinxresetverbatimhllines

\begin{sphinxadmonition}{warning}{Warning:}
(隘路事項) dbLoadRecord, dbLoadDatabaseの順番が逆になったりすると、うまく動作しない．しかも、".db"ファイルの１行目がおかしいというエラーメッセージがでるので、ミスリーディングである．st.cmd前後の状態も確認すべきである．
\end{sphinxadmonition}
\end{quote}

\item {} 
スクリプトに実行権限を与えておく．

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} chmod u+x \PYGZdl{}HOME/epics/app/pwmLED/iocBoot/iocpwmLED/st.cmd
\end{sphinxVerbatim}

\end{itemize}


\subsubsection{6. make 及び、初期化スクリプト "st.cmd" の実行}
\label{\detokenize{epics/rst/example4__arduino_LEDcontrol02:make-st-cmd}}\begin{itemize}
\item {} 
ベースディレクトリにて make する．

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} cd \PYGZdl{}HOME/epics/app/pwmLED/
\PYGZdl{} make distclean
\PYGZdl{} make
\end{sphinxVerbatim}

\item {} 
初期化スクリプトを実行する．

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} cd \PYGZdl{}HOME/epics/app/pwmLED/iocBoot/iocpwmLED/
\PYGZdl{} sudo ./st.cmd
\end{sphinxVerbatim}

\end{itemize}


\subsection{LEDのPWM制御状況の確認}
\label{\detokenize{epics/rst/example4__arduino_LEDcontrol02:ledpwm}}

\subsubsection{ローカルからのcamonitor}
\label{\detokenize{epics/rst/example4__arduino_LEDcontrol02:camonitor}}\begin{itemize}
\item {} 
別コンソールを立ち上げて、以下コマンドを実行

\begin{sphinxVerbatim}[commandchars=\\\{\}]
epics@raspberrypi: \PYGZti{} \PYGZdl{} caput epics:pwmLED 0   ( H も可 )
epics@raspberrypi: \PYGZti{} \PYGZdl{} caput epics:pwmLED 10  ( H も可 )
epics@raspberrypi: \PYGZti{} \PYGZdl{} caput epics:pwmLED 20  ( H も可 )
epics@raspberrypi: \PYGZti{} \PYGZdl{} caput epics:pwmLED 240 ( H も可 )
\end{sphinxVerbatim}

\item {} 
明るさが変更されることを確認した．

\end{itemize}


\subsubsection{OPI（手元macOS）からのCA}
\label{\detokenize{epics/rst/example4__arduino_LEDcontrol02:opi-macos-ca}}\begin{itemize}
\item {} 
pyEpicsからCA．

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} python3
\PYGZgt{}\PYGZgt{}\PYGZgt{} import epics
\PYGZgt{}\PYGZgt{}\PYGZgt{} epics.caput( \PYGZdq{}epics:pwmLED\PYGZdq{},  10 )
\PYGZgt{}\PYGZgt{}\PYGZgt{} epics.caput( \PYGZdq{}epics:pwmLED\PYGZdq{}, 240 )
\end{sphinxVerbatim}

\item {} 
OPIからIOCを介して、 \sphinxstylestrong{"LEDのPWM制御"} を実施することができた．

\end{itemize}


\subsection{参考URL}
\label{\detokenize{epics/rst/example4__arduino_LEDcontrol02:url}}\begin{itemize}
\item {} 
Arduino\sphinxhyphen{}EPICS サンプル ( KEK\sphinxhyphen{}EPICS Users JP, \sphinxurl{https://cerldev.kek.jp/trac/EpicsUsersJP/wiki/epics/arduino/simpleRead} )

\item {} 
Github:inigoalonso/setup\sphinxhyphen{}epics\sphinxhyphen{}serial\sphinxhyphen{}arduino ( arduino\sphinxhyphen{}EPICS  https://gist.github.com/inigoalonso/99d9076c672661a4b821 )

\item {} 
StreamDevice \sphinxhyphen{}protocol Files\sphinxhyphen{} ( \sphinxurl{https://paulscherrerinstitute.github.io/StreamDevice/protocol.html} )

\item {} 
Arduino PWM 制御 ( \sphinxurl{https://deviceplus.jp/arduino/how-to-control-led-with-arduino-pwm/} )

\end{itemize}


\chapter{References}
\label{\detokenize{epics/rst/epics_index:references}}\begin{itemize}
\item {} 
EPICS\sphinxhyphen{}controls ( newer version of website, \sphinxurl{https://epics-controls.org/} )

\item {} 
EPICS ( older version of website, \sphinxurl{https://epics.anl.gov/} )

\item {} 
EPICS Users JP ( KEK EPICS wiki,  \sphinxurl{https://cerldev.kek.jp/trac/EpicsUsersJP} )

\item {} 
その他資料リンク ( EPICS Users JP, \sphinxurl{https://cerldev.kek.jp/trac/EpicsUsersJP/wiki/intro} )

\item {} 
Getting\sphinxhyphen{}Started EPICS controls ( \sphinxurl{https://docs.epics-controls.org/projects/how-tos/en/latest/getting-started/installation.html} )

\item {} 
参考ノート： "\sphinxurl{https://note.com/dev\_associate/n/nfa4605c70f60}", "\sphinxurl{https://note.com/dev\_associate/n/nd886d700b10a}"

\item {} 
OPI/IOC通信時のポート番号、IPアドレスの設定 ( \sphinxurl{https://epics.anl.gov/EpicsDocumentation/AppDevManuals/ChannelAccess/cadoc\_4.htm} )

\item {} 
Arduino\sphinxhyphen{}EPICS サンプル ( KEK\sphinxhyphen{}EPICS Users JP, \sphinxurl{https://cerldev.kek.jp/trac/EpicsUsersJP/wiki/epics/arduino/simpleRead} )

\item {} 
Github:inigoalonso/setup\sphinxhyphen{}epics\sphinxhyphen{}serial\sphinxhyphen{}arduino ( arduino\sphinxhyphen{}EPICS  https://gist.github.com/inigoalonso/99d9076c672661a4b821 )

\item {} 
StreamDevice \sphinxhyphen{}protocol Files\sphinxhyphen{} ( \sphinxurl{https://paulscherrerinstitute.github.io/StreamDevice/protocol.html} )

\item {} 
Arduino PWM 制御 ( \sphinxurl{https://deviceplus.jp/arduino/how-to-control-led-with-arduino-pwm/} )

\item {} 
EPICS Record Reference ( \sphinxurl{https://epics.anl.gov/base/R7-0/6-docs/RecordReference.html} )

\end{itemize}



\renewcommand{\indexname}{索引}
\printindex
\end{document}